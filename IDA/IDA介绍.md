IDA是逆向工程的一个工具

## 反汇编

在传统的软件开发模型中，程序员使用编译器、汇编器和链接器中的一个或几个创建可执行程序。为了回溯编程过程（或对程序进行逆向工程），我们使用各种工具来撤销汇编和编译过程。 毫不奇怪，这些工具就叫做反汇编器和反编译器。反汇编器撤销汇编过程，因此，我们可以得到汇编语言形式的输出结果。


“恢复源代码”总是充满吸引力，但也极其困难。下面列举若干原因，说明为何反汇编困难重重：

- **编译过程会造成损失** 机器语言中没有变量或函数名，变量类型信息只有通过数据的用途（而不是显式的类型声明）来确定。看到一个32位的数据被传送，你需要进行一番分析，才能确定这个32位数据表示的到底是一个整数、一个32位浮点值还是一个32位指针。 

- **编译属于多对多对应关系** 这意味着源程序代码可以通过许多不同的方式转换成汇编语言，而机器语言也可以通过许多不同的方式转换成源程序代码

- **编译器代码优化** 例如：

    int a = 2*3;
    int c = a * b;

    会优化为: c = 6b;再进行编译。
    其实这个例子并不准确，只是为了说明编译器在编译代码时，会对代码做优化，而反汇编时，是不可能恢复到编译之前的最原始的代码状态。

### 为何反汇编

使用反汇编工具是为了在没有源代码的情况下促进对程序的了解。需要进行反汇编的常见情况包括以下几种：

- 分析恶意软件

- 分析闭源软件的漏洞

- 分析闭源软件的互操作性

- 分析编译器生成的代码，以验证编译器的性能和准确性

- 在调试时显示程序指令


### 如何反汇编

在反汇编时需要区分其中的**代码**和**数据**，并把代码转换成汇编语言显示给用户。

### 基本的反汇编算法

- 第一步。确定进行反汇编的代码区域。可反汇编文件必须符合可执行文件的某种通用格式，如 Windows 所使用的可移植可执行 （Portable Executable，PE）格式或许多Unix系统常用的可执行和链接格式（Executable and linking format，ELF）。这些格式通常含有一种机制，用来确定文件中包含代码和代码入口点的部分的位置。

- 第二步。知道指令的起始地址后，下一步就是读取该地址（或文件偏移量）所包含的值， 并执行一次表查找，将二进制操作码的值与它的汇编语言助记符对应起来。如读到`0x94`时，汇编指令对应`jz`，但`jz`并不能单独执行，需要再检索几个额外的字节，组成`jz xxxx`形式，完成反汇编一条指令。

- 第三步。对反汇编指令进行输出。

- 第四步。输出一条指令后，继续反汇编下一条指令，并重复上述过程，直到反汇编完文件中的所有指令。

#### 线性扫描反汇编

线性扫描反汇编算法采用一种非常简单的方法来确定需要反汇编的指令的位置：一条指令结束、另一条指令开始的地方。反汇编从一个代码段的第一个字节开始，以线性模式扫描整个代码段，逐条反汇编每条指令，直到完成整个代码段。 这种算法并不会通过识别分支等非线性指令来了解程序的控制流。


#### 递归下降反汇编

递归下降采用另外一种不同的方法来定位指令。递归下降算法强调控制流的概念。控制流根据一条指令是否被另一条指令引用来决定是否对其进行反汇编。


## IDA Pro入门

交互式反汇编器专业版（Interactive Disassembler Professional），人们常称为 IDA Pro，或 简称为 IDA。IDA 是 Hex-Rays 公司的旗舰产品。

![idapro](./images/1575878402(1).jpg)


### IDA的目录结构

```
├─cfg        // 包含各种配置文件，包括ida.cfg、idagui.cfg等
├─dbgsrv
├─idc        // 包含 IDA的内置脚本语言 IDC所需的核心文件。
├─ids        // 包含一些符号文件（IDA 语法中的 IDS 文件），这些文件用于描述可被加载到IDA的二进制文件引用的共享库的内容
├─loaders    // 包含在文件加载过程中用于识别和解析 PE或 ELF等已知文件格式的 IDA扩展
├─platforms
├─plugins    // 包含专门为IDA提供附加功能（多数情况下由用户定义）的IDA模块
├─procs      // 包含已安装的 IDA 版本所支持的处理器模块。
├─python
├─sig        // 包含IDA在各种模式匹配操作中利用的现有代码的签名。通过模式匹配，IDA能够将代码序列确定为已知的库代码，从而节省大量的分析时间。
└─til        // 包含一些类型库信息
```

### IDA的用户界面

启动界面
![quickstart](./images/1575879832(1).jpg)

- **New** 选择New将启动一个标准的 File Open对话框来选择将要分析的文件。

- **Go** Go按钮终止加载过程，使 IDA打开一个空白的工作区。

- **Previous** 使用Previous按钮可以打开其下“近用过的文件”列表中的一个文件。

选择分析类型
![loadfile](./images/1575880068(1).jpg)

数据库文件，包含分析的结果
![datafile](./images/1575880278(1).jpg)


用户界面
![userwindow](./images/1575879700(1).jpg)

1. 工具栏区域包含与 IDA的常用操作对应的工具
2. 彩色的水平带是 IDA的概况导航栏，也叫做导航带。导航带是被加载文件地址空间的线性视图。
3. IDA为当前打开的每一个数据显示窗口都提供了标签。
4. 反汇编视图是主要数据显示视图，它有两种不同的形式：图形视图（默认）和列表视图
5. 使用图形视图时，显示区很少能够一次显示某个函数的完整图形。这时，图形概况视图 （仅在使用图形视图时显示）可提供基本图形结构的缩小快照。
6. 列出IDA分析出的函数
7. 输出窗口显示的是 IDA输出的信息。


## 数据显示窗口

### 图形显示窗口

![graphwindow](./images/1575882696(1).jpg)

会发现，IDA使用不同的彩色箭头区分函数块之间各种类型的流。。根据条件，在条件跳转位置终止的块可能会生成两种流：Yes边的箭头（是的，执行分支）默认为绿色，No边的箭头（不，不执行分支）默认为红色。只有一个后继块的基本块会利用一个正常边（默认为蓝色）指向下一个即将执行的块。

控制方式：

- **平移** 除了使用“图形概况”窗口迅速定位图形外，你还可以通过单击和拖动图形视图的背景来定位图形。 

- **重新调整块的位置（不建议）** 通过单击指定块的标题栏并将其拖动到一个新位置，用户可以移动图 形中的每一个块的位置。

- **分组和折叠块** 可以对块分组，每个块单独分组，或者与其他块一起分组；并可将分组后的块折叠起来，以减少显示的混乱程度。折叠块特别有用，可以帮助你追踪已经 分析过的块。要折叠块，可以右击块的标题栏，然后在出现的菜单上选择“Group Nodes”。
 
- **创建其他反汇编窗口** 如果你想要同时查看两个不同函数的图形，可以通过命令再次打开另一个反汇编窗口。这样打开的第一个反汇编窗口叫做 IDA View-A。随后的反汇编窗口叫做IDA View-B、IDA View-C，依次类推。每个反汇编窗口都独立于其他窗口。


### 文本列表

![textview](./images/1575884276(1).jpg)

1. 显示窗口的左边部分叫做箭头窗口，用于描述函数中的非线性流程。实线箭头表示非条件跳转，虚线箭头则表示条件跳转。

2. 位置2的声明（也出现在图形视图中）是IDA对于函数栈帧布局的准确估算。IDA会对函数栈指针及函数使用的任何栈帧指针的行为进行仔细分析，从而计算出该函数的栈帧的结构。

3. 位置3的注释（以分号开头）属于交叉引用。它表示另一个程序指令将控制权转交给交叉引用注释所在位置的指令。


### 函数窗口

![functionwindow](./images/1575884714(1).jpg)

列出了函数在二进制文件中的虚拟地址、函数长度、局部变量所占内存大小、局部变量所占内存大小等信息。

### 其它窗口

输出窗口
![outputwindow](./images/1575885029(1).jpg)

输出窗口是IDA的输出控制台，从中可以找到与IDA所执行的任务有关的信息

十六进制窗口
![hexwindow](./images/1575885080(1).jpg)

导入表窗口
![importwindow](./images/1575885157(1).jpg)

导出表窗口
![exportwindow](./images/1575885203(1).jpg)

结构体窗口
![structwindow](./images/1575885287(1).jpg)

结构体窗口用于显示IDA决定在一个二进制文件中使用的任何复杂的数据结构（如C结构体和联合）的布局。在分析阶段，IDA会查询它的函数类型签名扩展库，设法将函数的参数类型与程序使用的内存匹配起来。

枚举窗口
![enumwindow](./images/1575885345(1).jpg)
枚举窗口有点类似于结构体窗口。如果IDA检测到标准枚举数据类型（C enum），它将在枚举窗口中列出该数据类型

其他窗口
![otherwindow](./images/1575885580(1).jpg)
其他窗口可使用如图方式显示。


## 反汇编导航

### 双击导航

![xref](./images/1575886406(1).jpg)

1是已命名的导航目标，双击可跳转到对应位置

2是交叉引用被当成导航目标，双击可跳转到引用位置


### 跳转到地址

![jumpaddress](./images/1575887173(1).jpg)

快捷键`G`打开`Jump to Address`对话框。

### 导航历史

![prehistory](./images/1575888036(1).jpg)

![nexthistory](./images/1575888105(1).jpg)

![fastheaderhistory](./images/1575888179(1).jpg)


### 栈帧

因为IDA Pro是一种低级分析工具，要利用它的许多功能和显示窗口，需要用户熟悉低级编程语言，其中许多概念与生成机器语言和管理由高级程序使用的内存有关。

栈帧是在程序的运行时栈中分配的内存块，专门用于特定的函数调用。

![stack](./images/1575888667(1).jpg)

#### 调用约定

1. C调用约定

2. stdcall调用约定

3. fastcall调用约定

4. thiscall调用约定


## 反汇编操作

