# 分层驱动

分层驱动是指两个或两个以上的驱动程序，它们分别创建设备对象，一层一层地“挂载”在其他设备对象之上，并且形成一个 **由高到低的设备对象栈**。
**IRP请求一般会被传送到设备栈的最顶层的设备对象，顶层的设备对象可以选择直接结束IRP请求，也可以选择将IRP请求向下层的设备对象转发。**
**如果是向下层设备对象转发IRP请求，当IRP请求结束时，IRP会顺着设备栈的反方向原路返回。**
**当得知下层驱动程序已经结束IRP请求时，本层设备对象可以选择继续将IRP向上返回，或者选择重新将IRP再次传递给底层设备驱动。**

在`DEVICE_OBJECT`结构体中有AttachedDevice这个参数，记录了自己这个设备**被**哪一个设备对象所挂载。

![local image](./images/1543485831(1).jpg)

图中的驱动HidUsb下的设备000000a9被驱动mouhid的一个设备所挂载，这个设备的地址是箭头起始处。

## 设备堆栈和挂载

> 挂载是将高一层的设备对象挂载在低一层的设备对象上，从而形成一个设备栈。

相关函数有`IoAttachDeviceToDeviceStack`、`IoAttachDevice`

当驱动程序卸载的时候，驱动程序所创建的设备对象应该从设备栈中弹出。出栈的顺序必须和入栈的顺序相反。
```
VOID 　IoDetachDevice( 　　IN OUT PDEVICE_OBJECT TargetDevice 　　);
```
** TargetDevice :它是位于被删除设备对象的低一层设备对象。** 

## I/O堆栈

在驱动模型中，有一个概念叫做`I/O堆栈`，用`IO_STACK_LOCATION`数据结构表示。它和设备栈紧密联合。

IRP一般会由应用程序的readfile或writefile创建，然后发送到设备堆栈的顶层。如果最上层的设备不处理IRP，就会将IRP转发到下一层设备。每一层设备都有可能处理IRP。IRP每穿越一层设备，就会用`IO_STACK_LOCATION`记录下本次操作的某些属性。

## 向下转发IRP

当顶层驱动的设备对象收到IRP请求并进入派遣函数后，有多种选择方式处理IRP

- 直接处理该IRP，即调用`IoCompleteRequest`内核函数。
- 调用`StartIO`，操作系统会将IRP请求串行化。除了当前运行的IRP，其他的IRP请求进入IRP队列。
- 选择让底层驱动完成IRP。
