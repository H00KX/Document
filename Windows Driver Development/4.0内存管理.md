## 内存管理

32位的虚拟内存空间按照0--4G的线性地址看待。

任何一个进程都定义了它自己的完整的4G空间，但是，其2G-4G之间的部分是所有进程共享的，称为**系统地址空间**，而0-2G的部分才是它自己私有的，称为**进程地址空间**。

为了有效的管理2G系统地址空间，Windows在初始化时将这2G划分成了一些固定的区域，各个区域有专门的用途。而且，**Windows内核使用了一组全局变量来记录每个区域的边界**。所以，系统地址的初始化实际上是对这些全局变量的初始化，并相应的初始化每个区域。Windows的一些引导选项以及系统配置（位于注册表）可能会影响到某些区域的位置和大小。

> 系统空间中的主要区域包括：内核模块映像、PFN数据库、换页内存池、非换页内存池、会话空间、系统缓存区、系统PTE区域、系统视图以及页表等。

## 内存管理器

内存管理器的一个重要任务是管理有限的物理内存。在windows的系统地址空间中，专门保留了一个称为**PFN数据库（page frame number database,页帧编号数据库）**的区域。每一个物理页面都对应于PFN数据库中的一项，此PFN项描述了该页面的状态。Windows支持八种状态：**活动、备用（standby）、已修改、已修改但不写出、转移、空闲、零化和坏状态**。



内存管理器有以下两个主要任务：
- 将一个进程的虚拟地址空间转译或者映射到物理内存中，这样，当一个在该进程的环境中运行的结各读写虚拟地址空间时，它可以引用到正确的物理地址[在一个进程的虚拟地址空间中，物理上驻留在内存中的那一部分子集被称为工作集]。
- 当内存被过度提交（也就是说，当运行结各或者系统代码试图使用比当前可用的量不过尔尔的物理内存）时，将内存中的有些内容转移到磁盘上；并且，在以后需要这些内容时，再将它们读回到物理内存中。

除了提供虚拟内存管理以外，内存管理器还提供了一组核心服务；
- 内存映射文件[在内部称为**内存区对象**]
- 写时复制内存
- 为应用程序使用大的、稀疏的地址空间提供支持
- 内存管理器提供了一种方法，使进程能够分配和使用的物理内存可以超过总共可被映射到进程虚拟地址空间中的大小（32位操作系统可以使用3G以上内存）

### 内存管理器组件
 内存管理器是Windows执行体的一部分，所以它位于文件Ntoskrnl.exe中。由以下组件构成：
 - 一组执行体系统服务，负责分配、释放和管理虚拟内存。绝大多数服务通过Windows API或者内核模式的设备驱动程序接口暴露出来。

---

虚拟内存机制    或  	页式内存管理

这是由CPU芯片内部（或外部）的`存储管理单元`MMU支持的。

采用页式内存管理时，程序中所使用的内存地址。CPU中的运算单元`ALU`所发出的都是“虚拟地址”，虚拟地址是不能直接用来访问物理内存的，需要由`MMU`将其“映射”到某个物理页面上转换成“物理地址”才能访问。

![image](./images/1568883056(1).jpg)

当MMU不存在时，或者没有被启用，那么ALU所使用的虚拟地址等同于物理内存所使用的物理地址。如果MMU存在并已被启用，由ALU所发出的虚拟地址就会由MMU映射成物理内存所用的物理地址。虚拟地址与物理地址在形式上并无区别，只是数值上的变化。**这种映射是以`页面`为单位的，而不是以单个地址为单位的，所以在实际映射的过程中需要进行一些计算和拼接。**MMU还担负着`检查访问权限`的任务，可以根据CPU的当前状态和所欲进行的访问形式而决定是否允许。


- 每个进程的虚拟地址的范围是相同的，但是实际映射的却是物理内存中的不同的部位。
- 不同进程的虚拟地址被映射到物理内存中不同的页面集合，每个进程都有自己的映射，互相之间没有交集，这就解决了`进程隔离`
- 把CPU的运行状态分成“用户态”和“内核态”，其虚拟地址范围也分成两部分，一部分用于内核，另一部分用于用户程序。


> 当系统中有多个进程并发运行时，所需存储空间的总合大于实际内存，这样就有必要对物理内存加以复用，**就是使同一个物理内存页面在不同的时间可被用于不同进程虚拟内存页面，而暂时不会被用到的虚拟内存页面的内容，则可以被存储在磁盘上。**


## MMU是怎么知道哪个虚拟内存应当被映射到哪个物理页面？

页面映射表：这实际上是个以虚拟内存页面号为下标的数组，数组中的元素称为页面映射表项，表项的内容决定了相应的虚存页面是否有映射、映射到哪一个页面，以及该物理页面的保护模式。

每当需要访问一个虚存页面时，MMU就以虚存页面号为下标从页面映射表中找到相应的表项，进而确定应该映射到哪一个物理页面，以及是否允许所要求的访问。

每个进程都有自己的页面映射表，CPU在执行哪一个进程的程序，就要哪个进程的页面映射表，为此x86处理器有个专门的控制寄存器`CR3`，这个寄存器总是指向当前进程的页面映射表（这里使用的是物理地址）。

如：以4KB的页面大小为例，4GB的虚存空间划分成1M个页面，所以整个页面映射表可以有1M个表项，每个表项4个字节，一共就是4MB的存储空间。


### 虚存的每次访问量否都要两次访问物理内存？
1. 访问CR3 ，找到映射表
2. 根据映射表找到所访问的物理地址

以上效率是很慢的。

解决办法：
CPU根据实际需要把当前用到的`页面映射表项`高速缓存在内部的`TLB`中。`TLB`意为`地址转换便查缓冲区(Translation Look-aside Buffer)`，是CPU内部一块专用的、特殊（只读）的高速缓存。每当需要使用一个页面映射表项时，MMU首先在TLB中寻找，找到就不需要访问物理内存了，找不到才从物理内存装入所需的表项。

后面这点有点难懂
![image](./images/1568886968(1).jpg)
